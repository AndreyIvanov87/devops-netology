# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя  
	Выполнить db.currentOp() чтобы выяснить opid , и по нему db.killOp(opid)
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB  
	Включить профайлер и анализировать его данные на предмет выявления проблемых запросов  
	https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/  

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи


Как вы думаете, в чем может быть проблема?  
	Редис удаляет из памяти значения с истекшим TTL или когда к этому значению пытаются повторно обратиться, или 10 раз в секунду проверяет набор рандомных значений на предмет истечения TTL и удаляет истекшие для очистки памяти. Если больше 25% ключей которые он проверил уже истекли, то после их очитски процедура запускается повторно.  
Если истешких таких ключей слишком много, редис может заблокировать работу, пока значение не упадет до меньшего 25%.  
 
## Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?  
	В документации указано, что обычно такая проблема возникает при сетевых сбоях либо если результат запроса слишком большой и большой объем данных не успевает передаться за отведенные лимиты времени. Судя по тому, что проблема проявилась не сама по себе, а с ростом количества записей, то дело скорее всего не в сети.  
Какие пути решения данной проблемы вы можете предложить?  
Попробовать увеличить в настройках сервера net_read_timeout до 60 и проверить - пожет это или нет.   
Проверить slow-query.log на предмет выполняющихся долго запросов, дать разработчикам и пользователям рекомендации по оптимизиции тех, которые в логе встречаются чаще всего.   

## Задача 4

Перед выполнением задания ознакомтесь со статьей [Common PostgreSQL errors](https://www.percona.com/blog/2020/06/05/10-common-postgresql-errors/) из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?  
	Из-за исчерпания ресурсов оперативной памяти на сервере.  
Как бы вы решили данную проблему?  
	Путем вертикального (добавить памяти) или горизонтального (добавить сервер, перенисти часть даных туда) масштабирования или/и оптимизацией текущих запросов к базе со стороны разработчиков.  

Исправление 2022-04-13:  
"На 4-й вопрос ответ не совсем верный. Представьте что у вас нет ресурсов на добавление памяти и масштабирование сервера. Как вы тогда поступите, рекомендую почитать документацию. Эта ошибка довольно просто гуглиться и по ней есть масса советов по устранению такой проблемы. Доработайте пожалуйста..."  

Можно увеличить размер файла подкачки, чтобы в системе не заканчивалась доступная память. Запросы требующие много памяти работать будут долго, но прибиваться после этого не должны.  
Для ubuntu,debian  
```bash
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```
и добавить в /etc/fstab  
/swapfile none swap sw 0 0

Размер файла подобрать по ситуации, допустим, примерно равным размеру физической ОЗУ на севрере для начала.  

---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
